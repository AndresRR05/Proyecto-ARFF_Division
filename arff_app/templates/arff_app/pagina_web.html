<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ARFF Visualizer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg: linear-gradient(120deg,#0f172a 0%, #0f172a 40%, #0b1220 100%);
            --card-bg: rgba(255,255,255,0.06);
            --glass: rgba(255,255,255,0.04);
            --accent: #6ee7b7; /* mint */
            --muted: #94a3b8;
        }
        html,body{height:100%;font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
        body{
            margin:0;
            padding:30px 20px;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.12), transparent 5%),
                        radial-gradient(1000px 500px at 90% 90%, rgba(16,185,129,0.06), transparent 10%),
                        #0b1220;
            color:#e6eef8;
        }
        .app-header{
            display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:18px;
        }
        .brand{display:flex;align-items:center;gap:12px}
        .brand .logo{
            width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;box-shadow:0 6px 18px rgba(2,6,23,0.6);
        }
        h1{font-size:1.25rem;margin:0;font-weight:600}
        .subtitle{color:var(--muted);font-size:.9rem}

        .card-modern{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 24px rgba(2,6,23,0.6);border-radius:12px}

    /* Dropzone */
        .dropzone{border:2px dashed rgba(255,255,255,0.06);padding:24px;border-radius:12px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:all .15s}
        .dropzone:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
        .dropzone.dragover{border-color:rgba(110,231,183,0.9);background:rgba(110,231,183,0.02)}
        .dropzone .dz-icon{font-size:1.9rem;color:var(--accent)}
        .file-meta{color:var(--muted);font-size:.95rem}

    /* selected file display */
    #selected-file{color:#ffffff;font-weight:600}

        /* Table wrapper */
        .table-responsive .dataframe{background:transparent}

        .plot-img{width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}

        .stats-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .stat-card{flex:1 1 150px;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);color:#ffffff}

        footer{margin-top:22px;color:var(--muted);font-size:.85rem;text-align:center}

        @media (max-width:767px){
            .brand h1{font-size:1rem}
            .stats-row{flex-direction:column}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <div class="brand">
                <div class="logo">AR</div>
                <div>
                    <h1>ARFF Visualizer</h1>
                    <div class="subtitle">Visualiza archivos .arff rápidamente</div>
                </div>
            </div>
        </div>

        <div class="card-modern p-4 mb-4">
            <form method="post" enctype="multipart/form-data" id="upload-form">
                {% csrf_token %}
                <div id="dropzone" class="dropzone mb-3" role="button">
                    <div class="dz-icon"><i class="bi bi-file-earmark-arrow-up"></i></div>
                    <div>
                        <div style="font-weight:600">Haz clic para seleccionar archivo</div>
                        <div class="file-meta">Tamaños grandes serán reducidos para poder visualizar</div>
                    </div>
                    <input id="file-input" type="file" name="arff_file" accept=".arff" style="display:none">
                    <div class="ms-auto text-end" style="min-width:220px;">
                        <div id="selected-file" class="text-white-50 small">Ningún archivo seleccionado</div>
                    </div>
                </div>

                <div class="d-flex justify-content-end align-items-center">
                    <div class="me-2 d-flex align-items-center">
                        <label for="display_rows" class="text-white-50 small me-2 mb-0">Filas:</label>
                        <select id="display_rows" name="display_rows" class="form-select form-select-sm" style="width:auto">
                            <option value="100" {% if display_rows == 100 %}selected{% endif %}>100</option>
                            <option value="250" {% if display_rows == 250 %}selected{% endif %}>250</option>
                            <option value="500" {% if display_rows == 500 %}selected{% endif %}>500</option>
                            <option value="1000" {% if display_rows == 1000 %}selected{% endif %}>1000</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-success d-flex align-items-center gap-2"><i class="bi bi-eye"></i> Visualizar</button>
                    </div>
                </div>
            </form>
        </div>

        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        {% if df_html %}
            <div class="mb-4">
                <div class="stats-row mb-3">
                    <div class="stat-card">
                        <div class="text-white-50">Archivo</div>
                        <div style="font-weight:700">{{ file_name }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white-50">Filas</div>
                        <div style="font-weight:700">{{ num_rows }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white-50">Columnas</div>
                        <div style="font-weight:700">{{ num_cols }}</div>
                    </div>
                </div>

                {% if truncated %}
                    <div class="alert alert-warning">Se muestran solo las primeras {{ display_rows }} filas del dataset para evitar sobrecarga.</div>
                {% endif %}

                <div class="card-modern p-3 mb-3">
                    <div class="table-responsive">
                        {{ df_html|safe }}
                    </div>
                </div>

                {% if protocol_col %}
                    <h5 class="mb-3">Distribución de {{ protocol_col }}</h5>
                    <div class="row g-3 mb-4" id="graphs-section">

                        {% if plots.prot_full %}
                        <div class="col-md-6">
                            <div class="card-modern p-2">
                                <img class="plot-img" src="data:image/png;base64,{{ plots.prot_full.thumb }}" alt="full"/>
                            </div>
                        </div>
                        {% endif %}

                        {% if plots.prot_train %}
                        <div class="col-md-6">
                            <div class="card-modern p-2">
                                <img class="plot-img" src="data:image/png;base64,{{ plots.prot_train.thumb }}" alt="train"/>
                            </div>
                        </div>
                        {% endif %}

                        {% if plots.prot_val %}
                        <div class="col-md-6">
                            <div class="card-modern p-2">
                                <img class="plot-img" src="data:image/png;base64,{{ plots.prot_val.thumb }}" alt="val"/>
                            </div>
                        </div>
                        {% endif %}

                        {% if plots.prot_test %}
                        <div class="col-md-6">
                            <div class="card-modern p-2">
                                <img class="plot-img" src="data:image/png;base64,{{ plots.prot_test.thumb }}" alt="test"/>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                {% endif %}
            </div>
        {% endif %}

        <footer>
            <div>ARFF Visualizer</div>
        </footer>
    </div>

    <!-- Small scripts to improve UX: show filename, handle drag & drop -->
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const drop = document.getElementById('dropzone');
            const input = document.getElementById('file-input');
            const sel = document.getElementById('selected-file');
            console.log('Dropzone script loaded', {drop: !!drop, input: !!input, sel: !!sel});

            // Click on dropzone opens file dialog
            drop.addEventListener('click', () => input.click());

            // Reflect selected file
            input.addEventListener('change', (e) => {
                console.log('file input change event', e);
                const f = e.target.files[0];
                sel.textContent = f ? `${f.name} — ${Math.round(f.size/1024)} KB` : 'Ningún archivo seleccionado';
            });

            // Drag & Drop
            ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e)=>{e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover');}));
            ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e)=>{e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover');}));

            drop.addEventListener('drop', (e)=>{
                console.log('drop event', e);
                const dt = e.dataTransfer;
                if(dt && dt.files && dt.files.length){
                    try{
                        // asigna al input
                        input.files = dt.files;
                    }catch(err){
                        console.warn('Could not set input.files directly', err);
                    }
                    const f = dt.files[0];
                    sel.textContent = f ? `${f.name} — ${Math.round(f.size/1024)} KB` : 'Ningún archivo seleccionado';
                }
            });

            // Smooth scroll to graphs if present after submit (optional enhancement)
            const form = document.getElementById('upload-form');
            form.addEventListener('submit', ()=>{
                // small UX: let server handle upload; when page reloads it will show graphs
            });
        });
    </script>

</body>
</html>